import{Q as q}from"./QItemLabel.aabbfeaa.js";import{Q as R,a as S}from"./QItem.3abe05b4.js";import{Q as T}from"./QList.3193c694.js";import{Q as P}from"./QPage.ea4e39d9.js";import{A as $}from"./AreaAllocationResource.c7565631.js";import{u as L,a as B}from"./useQuery.esm.6e7da3a0.js";import{b as z}from"./useBudgets.4ed977f0.js";import{u as j}from"./useMoney.dbc60660.js";import{M as x,m as D}from"./constants.e9961e47.js";import{c as C,j as N,M as G,r as H,p,k as A,l as u,d,u as l,ba as J,m as O,bc as W,s as _,t as M,q as v,ae as X,ai as Y,F as Z,ah as tt}from"./index.a852c7dd.js";import{Q as ot}from"./QInput.5a757dc1.js";import{c as at}from"./index.7adaf3a2.js";import{Q as et}from"./QForm.1eb75f72.js";import{a as k}from"./index.2cf0d985.js";import{l as g}from"./layout.1849cf49.js";import{u as V}from"./useMutation.esm.e5230e92.js";import"./use-dark.84119dd2.js";import"./BudgetResource.e21a87b9.js";import"./utils.esm.3b6b5005.js";import"./use-key-composition.0193e5f8.js";import"./focus-manager.387b0375.js";import"./mutation.esm.b0df21c1.js";const st=async({budgetId:o,areaId:t})=>{const{data:e}=await $.getAreaAllocationByuBudgetIdAndAreaId({budgetId:o,areaId:t});return e},nt=({budgetId:o,areaId:t})=>{const{isLoading:e,isError:i,data:a,error:n}=L({queryKey:["area-allocation-by-budget-and-area",o,t],queryFn:()=>st({budgetId:o,areaId:t}),staleTime:6e5,retry:(r,s)=>{var m;return((m=s==null?void 0:s.response)==null?void 0:m.status)!==404}});return{isLoading:e,isError:i,data:a,error:n}},rt=async(o,t)=>{const{data:e}=await x.getMonthlyAllocations(o,t);return e},it=({areaId:o,budgetYear:t})=>{const e=C(()=>!!o&&!!t.value),{isLoading:i,isError:a,data:n,error:r}=L({queryKey:["monthly-area-allocations",o],queryFn:()=>{var s;return rt(o,(s=t.value)==null?void 0:s.year)},enabled:e,staleTime:1e3*60*10});return{isLoadingAllocations:i,isErrorAllocations:a,allocations:n,errorAllocations:r}},lt=async o=>{const{data:t}=await x.storeMonthlyAllocation(o);return t},ct=()=>{const o=B(),{mutateAsync:t,isLoading:e,isError:i}=V({mutationFn:lt,onSuccess:async a=>{await o.invalidateQueries({queryKey:["monthly-area-allocations",a.areaId]}),g.showSuccessNotification("Asignacion creada con \xE9xito")},onError:a=>{let n="Error al crear asignaci\xF3n.";if(k.isAxiosError(a)){const r=a;if(r.response){const s=r.response.data;(r.response.status===400&&s.message||s.message)&&(n=s.message)}else r.message&&(n=r.message)}else a instanceof Error&&(n=a.message);g.showErrorNotification(n)}});return{createMonthlyAllocationMutation:t,isLoading:e,isError:i}},ut=async o=>{const{data:t}=await x.updateMonthlyAllocation(o.uuid,o);return t},mt=()=>{const o=B(),{mutateAsync:t,isLoading:e,isError:i}=V({mutationFn:ut,onSuccess:async a=>{await o.invalidateQueries({queryKey:["monthly-area-allocations",a.areaId]}),g.showSuccessNotification("Asignacion actualizada con \xE9xito")},onError:a=>{let n="Error al actualizar asignaci\xF3n.";if(k.isAxiosError(a)){const r=a;if(r.response){const s=r.response.data;(r.response.status===400&&s.message||s.message)&&(n=s.message)}else r.message&&(n=r.message)}else a instanceof Error&&(n=a.message);g.showErrorNotification(n)}});return{updateMonthlyAllocationMutation:t,isUpdating:e,isError:i}},dt=N({__name:"MonthlyAllocationForm",props:{monthlyAllocation:{default:()=>({areaId:"",month:0,year:0,allocatedAmount:0,uuid:""})},month:null,year:null,areaId:null},setup(o){const t=o,e=G(at(t.monthlyAllocation)),i=H(),{createMonthlyAllocationMutation:a,isLoading:n}=ct(),{updateMonthlyAllocationMutation:r,isUpdating:s}=mt(),m=async()=>{t.monthlyAllocation.uuid?await r({uuid:t.monthlyAllocation.uuid,allocatedAmount:e.allocatedAmount.toString()}):await a({areaId:t.areaId,month:t.month,year:t.year,allocatedAmount:e.allocatedAmount.toString()})},y=[c=>c>=0||"Solo se permiten n\xFAmeros positivos",c=>/^\d+(\.\d{1,2})?$/.test(c)||"Solo se permiten m\xE1ximo dos decimales y un punto decimal"];return(c,h)=>(p(),A(l(et),{ref_key:"qAllocationForm",ref:i,onSubmit:J(m,["prevent"])},{default:u(()=>[d(ot,{modelValue:e.allocatedAmount,"onUpdate:modelValue":h[0]||(h[0]=E=>e.allocatedAmount=E),modelModifiers:{number:!0},dense:"",disable:l(n)||l(s),hint:"Presione enter para guardar","input-class":"text-right",label:"Monto Asignado",outlined:"",prefix:"$",rules:y,type:"text"},null,8,["modelValue","disable"])]),_:1},8,["onSubmit"]))}}),pt=_("h4",{class:"text-h4"},"Asignaciones",-1),yt={class:"tw-font-semibold tw-text-gray-700"},ft={class:"tw-font-semibold tw-text-gray-700"},Rt=N({__name:"Index",setup(o){const t=O(),{userAreaId:e}=W(),{budgetId:i}=t.params,{data:a,isLoading:n,isError:r,error:s}=nt({budgetId:i,areaId:e.value}),{currencyFormat:m}=j(),{budget:y}=z(i),{allocations:c,isErrorAllocations:h,isLoadingAllocations:E,errorAllocations:At}=it({areaId:e.value,budgetYear:y}),U=C(()=>c.value?c.value.reduce((b,w)=>b+ +w.allocatedAmount,0):0);return(b,w)=>(p(),A(P,{padding:""},{default:u(()=>{var Q;return[pt,_("p",yt,"Techo Presupuestal: "+M(l(m)(((Q=l(a))==null?void 0:Q.totalAmount)||0)),1),_("p",ft,"Acumulado: "+M(l(m)(l(U)||0)),1),l(c)?(p(),A(T,{key:0,bordered:"",class:"tw-w-full lg:tw-w-1/2",separator:""},{default:u(()=>[d(q,{class:"q-pa-md bg-grey-2"},{default:u(()=>[v("Meses y Asignaciones")]),_:1}),(p(!0),X(Z,null,Y(l(D),f=>(p(),A(R,{key:f.id,class:"q-pa-sm"},{default:u(()=>[d(S,null,{default:u(()=>[d(q,null,{default:u(()=>[v(M(f.nombre),1)]),_:2},1024)]),_:2},1024),d(S,{side:""},{default:u(()=>{var F,I;return[d(dt,{"area-id":l(e),month:f.id,"monthly-allocation":(F=l(c))==null?void 0:F.find(K=>K.month===f.id),year:(I=l(y))==null?void 0:I.year},null,8,["area-id","month","monthly-allocation","year"])]}),_:2},1024)]),_:2},1024))),128))]),_:1})):tt("",!0)]}),_:1}))}});export{Rt as default};
