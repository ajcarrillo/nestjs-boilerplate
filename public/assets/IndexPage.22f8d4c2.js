import{Q as ae}from"./QSpace.67f8efee.js";import{Q as ne}from"./QToggle.a71d529d.js";import{j as X,r as b,M as J,p as V,k as w,l as a,d as e,u as v,_ as z,X as q,b9 as re,o as oe,w as G,c as le,V as se,m as ue,s as ie,t as H,q as me,aj as de,O as pe}from"./index.94a2a2c4.js";import{a as _e,Q as ce}from"./QTable.599b7865.js";import{Q as fe}from"./QPage.42982557.js";import{T as be}from"./TablePage.cfcb1cda.js";import{p as T}from"./planeacion.api.2f123763.js";import{l as S}from"./layout.b5017cfe.js";import{u as ye,a as Z}from"./QChip.0a8cd9e9.js";import{u as ee}from"./useMutation.esm.cf1ab3a1.js";import{_ as ge}from"./CardDialog.9d56c950.js";import{Q as Y}from"./QInput.af5d33a8.js";import{Q as c,a as f}from"./QItemLabel.9fc93834.js";import{Q as he}from"./QSelect.890a90f4.js";import{Q as ve}from"./QCheckbox.3b045c53.js";import{Q as K}from"./QFile.663c6bda.js";import{Q as ke}from"./QList.6a801bd8.js";import{Q as Oe}from"./QCardSection.c5d91bb3.js";import{a as Pe}from"./format.530b5a56.js";import{Q as Ve}from"./QCardActions.d5c3609a.js";import{Q as we}from"./QForm.43443744.js";import{c as R}from"./index.7adaf3a2.js";import{_ as Fe}from"./DatePicker.92b8a63f.js";import{b as Qe}from"./usePurchaseOrders.019a1acd.js";import{F as qe}from"./FilePreview.5c85482c.js";import{d as Se}from"./date.c481a073.js";import{u as xe}from"./useMoney.dbc60660.js";import"./use-dark.4d6c2b3e.js";import"./scroll.dcc6a748.js";import"./QCard.388c49b9.js";import"./plugin-vue_export-helper.21dcd24c.js";import"./index.2cf0d985.js";import"./utils.esm.80f6f92b.js";import"./mutation.esm.a11809f3.js";import"./QPopupProxy.10703a00.js";import"./ClosePopup.d071249d.js";import"./QTooltip.b661aa61.js";import"./QImg.2c00d1c6.js";function W(t){const r=new FormData;return r.append("payment_number",t.payment_number),r.append("payment_date",t.payment_date),r.append("amount",t.amount.toString()),r.append("purchase_order_id",t.purchase_order_id),r.append("check_number",t.check_number||""),r.append("is_submitted_to_finance",t.is_submitted_to_finance),t.paymentFile&&r.append("payment_file",t.paymentFile),t.checkFile&&r.append("check_file",t.checkFile),r}var j={getPaymentOrders({show:t}){console.log({show:t});const r=t===!1?"presupuestos":"subpresupuestos";return T.get(`/payment-orders?show=${r}`)},storePaymentOrder(t){const r=W(t);return T.post("/payment-orders",r,{headers:{"Content-Type":"multipart/form-data"}})},updatePaymentOrder(t){const{...r}=t,{id:y}=r;delete r.id;const k=W(r);return T.patch(`/payment-orders/${y}`,k,{headers:{"Content-Type":"multipart/form-data"}})}};const De=async({show:t})=>(await j.getPaymentOrders({show:t})).data,Ce=async t=>(await j.storePaymentOrder(t)).data,Me=async t=>(await j.updatePaymentOrder(t)).data,Ie=({show:t})=>({queryPaymentOrders:ye({queryKey:["paymentOrders",{show:t}],queryFn:()=>De({show:t.value}),staleTime:6e4})}),Ne=()=>{const t=Z();return{storePaymentOrderMutation:ee({mutationFn:Ce,onSuccess:async()=>{await t.invalidateQueries(["paymentOrders"]),S.showSuccessNotification("Orden de pago creada")},onError:()=>{S.showErrorNotification("No se pudo crear la orden de pago")}})}},Ue=()=>{const t=Z();return{updatePaymentOrderMutation:ee({mutationFn:Me,onSuccess:async()=>{await t.invalidateQueries(["paymentOrders"]),S.showSuccessNotification("Orden de pago actualizada")},onError:()=>{S.showErrorNotification("No se pudo actualizar la orden de pago")}})}},Ae=X({__name:"PaymentOrderForm",props:{paymentOrder:{default:()=>({purchase_order_id:"",payment_number:"",amount:0,payment_date:new Date().toISOString().substring(0,10),payment_file:"",check_number:"",check_file:"",is_submitted_to_finance:!1})}},emits:["close"],setup(t,{emit:r}){const y=t,k="https://nestjs-boilerplate-production.up.railway.app",{storePaymentOrderMutation:_}=Ne(),{updatePaymentOrderMutation:O}=Ue(),{dictionary:x}=Qe(),g=b(),B={purchase_order_id:"",payment_number:"",amount:0,payment_date:new Date().toISOString().substring(0,10),payment_file:"",check_number:"",check_file:"",is_submitted_to_finance:!1},n=J(R(y.paymentOrder)||R(B)),h={purchase_order_id:[l=>!!l||"La orden de compra es requerida"],payment_number:[l=>!!l||"El n\xFAmero de pago es requerido",l=>l.length==3||"El n\xFAmero de pago debe tener 3 d\xEDgitos",l=>!isNaN(Number(l))||"El n\xFAmero de pago debe ser un n\xFAmero"],amount:[l=>!!l||"El monto es requerido",l=>!isNaN(Number(l))||"El monto debe ser un n\xFAmero"],payment_date:[l=>!!l||"La fecha de pago es requerida"]},m=b(),d=b();async function F(){var s,o;await((s=g.value)==null?void 0:s.validate())&&(n.hasOwnProperty("id")?await O.mutateAsync(n):(await _.mutateAsync(n),(o=g.value)==null||o.reset(),r("close")))}function P(){n.purchase_order_id="",n.payment_number="",n.amount=0,n.payment_date=new Date().toISOString().substring(0,10),n.payment_file="",n.check_number="",n.check_file="",n.is_submitted_to_finance=!1,m.value=void 0,d.value=void 0}function D(l){n.paymentFile=l}function C(l){n.checkFile=l}return(l,s)=>(V(),w(v(we),{ref_key:"qPaymentOrderForm",ref:g,onReset:P,onSubmit:re(F,["prevent"])},{default:a(()=>[e(Oe,null,{default:a(()=>[e(ke,null,{default:a(()=>[e(c,null,{default:a(()=>[e(f,null,{default:a(()=>[e(Y,{modelValue:n.payment_number,"onUpdate:modelValue":s[0]||(s[0]=o=>n.payment_number=o),dense:"",label:"N\xFAmero de pago",outlined:"",rules:h.payment_number},null,8,["modelValue","rules"])]),_:1})]),_:1}),e(c,null,{default:a(()=>[e(f,null,{default:a(()=>[e(Fe,{modelValue:n.payment_date,"onUpdate:modelValue":s[1]||(s[1]=o=>n.payment_date=o),rules:h.payment_date},null,8,["modelValue","rules"])]),_:1})]),_:1}),e(c,null,{default:a(()=>[e(f,null,{default:a(()=>[e(Y,{modelValue:n.amount,"onUpdate:modelValue":s[2]||(s[2]=o=>n.amount=o),modelModifiers:{number:!0},dense:"",label:"Monto",outlined:"",rules:h.amount},null,8,["modelValue","rules"])]),_:1})]),_:1}),e(c,null,{default:a(()=>[e(f,null,{default:a(()=>[e(he,{modelValue:n.purchase_order_id,"onUpdate:modelValue":s[3]||(s[3]=o=>n.purchase_order_id=o),dense:"","emit-value":"",label:"Orden de compra","map-options":"",options:v(x),outlined:"",rules:h.purchase_order_id},null,8,["modelValue","options","rules"])]),_:1})]),_:1}),e(c,null,{default:a(()=>[e(f,null,{default:a(()=>[e(ve,{modelValue:n.is_submitted_to_finance,"onUpdate:modelValue":s[4]||(s[4]=o=>n.is_submitted_to_finance=o),dense:"",label:"\xBFSe envi\xF3 a finanzas?",outlined:""},null,8,["modelValue"])]),_:1})]),_:1}),e(c,null,{default:a(()=>[e(f,null,{default:a(()=>[n.payment_file?(V(),w(qe,{key:1,"file-url":`${v(k)}/api/files/payment-orders/${n.id}/${n.payment_file}`},{activator:a(({showPreview:o})=>[e(q,{color:"primary",dense:"",flat:"",icon:"visibility",label:"Ver archivo de pago",unelevated:"",onClick:o},null,8,["onClick"])]),_:1},8,["file-url"])):(V(),w(K,{key:0,modelValue:m.value,"onUpdate:modelValue":[s[5]||(s[5]=o=>m.value=o),D],accept:".jpg, image/*, application/pdf",dense:"",label:"Archivo de pago",loading:!1,name:"payment_file",outlined:"","use-chips":""},{prepend:a(()=>[e(z,{name:"attach_file"})]),_:1},8,["modelValue"]))]),_:1})]),_:1}),e(c,null,{default:a(()=>[e(f,null,{default:a(()=>[e(Y,{modelValue:n.check_number,"onUpdate:modelValue":s[6]||(s[6]=o=>n.check_number=o),dense:"",label:"N\xFAmero de cheque",outlined:""},null,8,["modelValue"])]),_:1})]),_:1}),e(c,null,{default:a(()=>[e(f,null,{default:a(()=>[e(K,{modelValue:d.value,"onUpdate:modelValue":[s[7]||(s[7]=o=>d.value=o),C],accept:".jpg, image/*, application/pdf",dense:"",label:"Archivo de cheque",loading:!1,name:"check_file",outlined:"","use-chips":""},{prepend:a(()=>[e(z,{name:"attach_file"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),e(Pe),e(Ve,{align:"right"},{default:a(()=>[e(q,{color:"primary",label:"Guardar",type:"submit"})]),_:1})]),_:1},8,["onSubmit"]))}});const Ee={class:"q-table__title"},$=Se.formatDate,Pt=X({__name:"IndexPage",setup(t){const r=se(),y=ue(),k=y.query.show||"presupuestos",_=b(k==="subpresupuestos"),{currencyFormat:O}=xe(),{queryPaymentOrders:x}=Ie({show:_}),{data:g,isLoading:B,isError:n}=x,h=[{name:"a_description",field:"a_description",label:"Departamento",align:"left",sortable:!0},{name:"sb_event",field:"sb_event",label:"Evento",sortable:!1,align:"left"},{name:"po_payment_number",field:"po_payment_number",label:"Orden de pago",align:"right",sortable:!0},{name:"po_amount",field:u=>O(+u.po_amount),label:"Total real",align:"right",sortable:!0},{name:"po_payment_date",field:u=>$(u.po_payment_date,"YYYY-MM-DD"),label:"Fecha de pago",align:"center",sortable:!0},{name:"por_order_number",field:"por_order_number",label:"Orden de compra",align:"right",sortable:!0},{name:"por_reception_date",field:u=>$(u.por_reception_date,"YYYY-MM-DD"),label:"Orden de compra fecha de recepci\xF3n",align:"center",sortable:!0},{name:"r_requisition_number",field:"r_requisition_number",label:"Requisici\xF3n",align:"right",sortable:!0},{name:"r_estimated_amount",field:u=>O(+u.r_estimated_amount),label:"Estimado",align:"right",sortable:!0},{name:"rsb_requisition_number",field:"rsb_requisition_number",label:"Requisici\xF3n",align:"right",sortable:!0},{name:"rsb_estimated_amount",field:u=>O(+u.rsb_estimated_amount),label:"Estimado",align:"right",sortable:!0}],m=b(["a_description","po_payment_number","po_amount","po_payment_date","por_order_number","por_reception_date","r_requisition_number","r_estimated_amount"]),d=b(!1),F=b(-1);let P=J({purchase_order_id:"",payment_number:"",amount:0,payment_date:new Date().toISOString().substring(0,10),payment_file:"",check_number:"",check_file:"",is_submitted_to_finance:!1});const D={purchase_order_id:"",payment_number:"",amount:0,payment_date:new Date().toISOString().substring(0,10),payment_file:"",check_number:"",check_file:"",is_submitted_to_finance:!1};oe(()=>{_.value&&(m.value.splice(1,0,"sb_event"),m.value.splice(7,2,"rsb_requisition_number","rsb_estimated_amount"))}),G(d,u=>{u||s()}),G(_,u=>{r.replace({query:{...y.query,show:u?"subpresupuestos":"presupuestos"}}),u?(m.value.splice(1,0,"sb_event"),m.value.splice(7,2,"rsb_requisition_number","rsb_estimated_amount")):(m.value.splice(1,1),m.value.splice(6,2,"r_requisition_number","r_estimated_amount"))});const C=le(()=>_.value?"\xD3rdenes de pago/SubPresupuestos":"\xD3rdenes de pago/Presupuestos");function l(u){var L;const{payment_number:p,amount:i,payment_date:Q,payment_file:M,check_number:I,check_file:N,id:U,is_submitted_to_finance:A,purchase_order_id:E}=o(u);F.value=(L=g.value)==null?void 0:L.findIndex(te=>te.po_id===u.po_id),P=Object.assign({},{id:U,purchase_order_id:E,payment_number:p,amount:i,payment_date:Q,payment_file:M,check_number:I,check_file:N,is_submitted_to_finance:A}),d.value=!0}function s(){d.value=!1,pe(()=>{P=R(D),F.value=-1})}function o(u){const{po_payment_number:p,po_amount:i,po_payment_date:Q,po_payment_file:M,po_check_number:I,po_check_file:N,po_id:U,po_is_submitted_to_finance:A,po_purchase_order_id:E}=u;return{id:U,purchase_order_id:E,payment_number:p,amount:+i,payment_date:$(Q,"YYYY-MM-DD"),payment_file:M,check_number:I,check_file:N,is_submitted_to_finance:A}}return(u,p)=>(V(),w(fe,null,{default:a(()=>[e(be,null,{"card-body":a(()=>[e(_e,{columns:h,flat:"",rows:v(g),"visible-columns":m.value,"wrap-cells":""},{top:a(()=>[ie("div",Ee,H(v(C)),1),e(ae),e(ne,{modelValue:_.value,"onUpdate:modelValue":p[0]||(p[0]=i=>_.value=i),class:"tw-mr-4",label:"Mostrar las \xF3rdenes de pago de los SubPresupuestos"},null,8,["modelValue"]),e(q,{color:"primary",label:"Nueva orden de pago",onClick:p[1]||(p[1]=i=>d.value=!0)})]),"body-cell-po_payment_number":a(i=>[e(ce,{props:i},{default:a(()=>[i.value?(V(),w(q,{key:0,color:"primary",flat:"","no-caps":"",onClick:Q=>l(i.row)},{default:a(()=>[me(H(i.value),1)]),_:2},1032,["onClick"])):de("",!0)]),_:2},1032,["props"])]),_:1},8,["rows","visible-columns"])]),footer:a(()=>[e(ge,{modelValue:d.value,"onUpdate:modelValue":p[2]||(p[2]=i=>d.value=i),"card-title":"Orden de pago",class:"form-payment-order"},{default:a(({closeDialog:i})=>[e(Ae,{"payment-order":v(P),onClose:i},null,8,["payment-order","onClose"])]),_:1},8,["modelValue"])]),_:1})]),_:1}))}});export{Pt as default};
