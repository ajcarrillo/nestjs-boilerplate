import{Q as q}from"./QItemLabel.b3a0c01c.js";import{Q as K,a as v}from"./QItem.3270a199.js";import{Q as T}from"./QList.1e036a38.js";import{Q as z}from"./QPage.6112cc6b.js";import{A as P}from"./AreaAllocationResource.73bcf67b.js";import{u as S,a as B}from"./useQuery.esm.08e598e9.js";import{b as R}from"./useBudgets.061f776f.js";import{u as D}from"./useMoney.dbc60660.js";import{p as h}from"./BudgetResource.3a0abb0c.js";import{c as C,j as N,M as J,r as Y,p as y,k as A,l as c,d,u as l,ba as j,m as G,bc as H,s as M,t as b,q as L,ae as O,ai as W,F as X,ah as Z}from"./index.33aee9c3.js";import{Q as oo}from"./QInput.bc534865.js";import{c as ao}from"./index.7adaf3a2.js";import{Q as to}from"./QForm.05da6a20.js";import{a as k}from"./index.2cf0d985.js";import{l as f}from"./layout.880d2741.js";import{u as V}from"./useMutation.esm.5aff8292.js";import"./use-dark.a42b1db8.js";import"./utils.esm.aa7cdc1a.js";import"./use-key-composition.b1866cfc.js";import"./focus-manager.387b0375.js";import"./mutation.esm.9a94c1b8.js";const eo=async({budgetId:a,areaId:o})=>{const{data:e}=await P.getAreaAllocationByuBudgetIdAndAreaId({budgetId:a,areaId:o});return e},no=({budgetId:a,areaId:o})=>{const{isLoading:e,isError:i,data:t,error:r}=S({queryKey:["area-allocation-by-budget-and-area",a,o],queryFn:()=>eo({budgetId:a,areaId:o}),staleTime:6e5,retry:(s,n)=>{var u;return((u=n==null?void 0:n.response)==null?void 0:u.status)!==404}});return{isLoading:e,isError:i,data:t,error:r}};var _={getMonthlyAllocations(a,o){return h.get(`/monthly-area-allocation/${a}?budgetYear=${o}`)},storeMonthlyAllocation(a){return h.post(`/monthly-area-allocation?budgetYear=${a.year}`,a)},updateMonthlyAllocation(a,o){return h.patch(`/monthly-area-allocation/${a}`,{allocatedAmount:o.allocatedAmount})}};const ro=async(a,o)=>{const{data:e}=await _.getMonthlyAllocations(a,o);return e},so=({areaId:a,budgetYear:o})=>{const e=C(()=>!!a&&!!o.value),{isLoading:i,isError:t,data:r,error:s}=S({queryKey:["monthly-area-allocations",a],queryFn:()=>{var n;return ro(a,(n=o.value)==null?void 0:n.year)},enabled:e,staleTime:1e3*60*10});return{isLoadingAllocations:i,isErrorAllocations:t,allocations:r,errorAllocations:s}},io=[{id:1,nombre:"Enero"},{id:2,nombre:"Febrero"},{id:3,nombre:"Marzo"},{id:4,nombre:"Abril"},{id:5,nombre:"Mayo"},{id:6,nombre:"Junio"},{id:7,nombre:"Julio"},{id:8,nombre:"Agosto"},{id:9,nombre:"Septiembre"},{id:10,nombre:"Octubre"},{id:11,nombre:"Noviembre"},{id:12,nombre:"Diciembre"}],lo=async a=>{const{data:o}=await _.storeMonthlyAllocation(a);return o},co=()=>{const a=B(),{mutateAsync:o,isLoading:e,isError:i}=V({mutationFn:lo,onSuccess:async t=>{await a.invalidateQueries({queryKey:["monthly-area-allocations",t.areaId]}),f.showSuccessNotification("Asignacion creada con \xE9xito")},onError:t=>{let r="Error al crear asignaci\xF3n.";if(k.isAxiosError(t)){const s=t;if(s.response){const n=s.response.data;(s.response.status===400&&n.message||n.message)&&(r=n.message)}else s.message&&(r=s.message)}else t instanceof Error&&(r=t.message);f.showErrorNotification(r)}});return{createMonthlyAllocationMutation:o,isLoading:e,isError:i}},uo=async a=>{const{data:o}=await _.updateMonthlyAllocation(a.uuid,a);return o},mo=()=>{const a=B(),{mutateAsync:o,isLoading:e,isError:i}=V({mutationFn:uo,onSuccess:async t=>{await a.invalidateQueries({queryKey:["monthly-area-allocations",t.areaId]}),f.showSuccessNotification("Asignacion actualizada con \xE9xito")},onError:t=>{let r="Error al actualizar asignaci\xF3n.";if(k.isAxiosError(t)){const s=t;if(s.response){const n=s.response.data;(s.response.status===400&&n.message||n.message)&&(r=n.message)}else s.message&&(r=s.message)}else t instanceof Error&&(r=t.message);f.showErrorNotification(r)}});return{updateMonthlyAllocationMutation:o,isUpdating:e,isError:i}},yo=N({__name:"MonthlyAllocationForm",props:{monthlyAllocation:{default:()=>({areaId:"",month:0,year:0,allocatedAmount:0,uuid:""})},month:null,year:null,areaId:null},setup(a){const o=a,e=J(ao(o.monthlyAllocation)),i=Y(),{createMonthlyAllocationMutation:t,isLoading:r}=co(),{updateMonthlyAllocationMutation:s,isUpdating:n}=mo(),u=async()=>{o.monthlyAllocation.uuid?await s({uuid:o.monthlyAllocation.uuid,allocatedAmount:e.allocatedAmount.toString()}):await t({areaId:o.areaId,month:o.month,year:o.year,allocatedAmount:e.allocatedAmount.toString()})};return(g,m)=>(y(),A(l(to),{ref_key:"qAllocationForm",ref:i,onSubmit:j(u,["prevent"])},{default:c(()=>[d(oo,{modelValue:e.allocatedAmount,"onUpdate:modelValue":m[0]||(m[0]=E=>e.allocatedAmount=E),modelModifiers:{number:!0},dense:"",disable:l(r)||l(n),hint:"Presione enter para guardar",label:"Monto Asignado",min:"0",outlined:"",type:"number"},null,8,["modelValue","disable"])]),_:1},8,["onSubmit"]))}}),po=M("h4",{class:"text-h4"},"Asignaciones",-1),Ao={class:"tw-font-semibold tw-text-gray-700"},fo={class:"tw-font-semibold tw-text-gray-700"},To=N({__name:"Index",setup(a){const o=G(),{userAreaId:e}=H(),{budgetId:i}=o.params,{data:t,isLoading:r,isError:s,error:n}=no({budgetId:i,areaId:e.value}),{currencyFormat:u}=D(),{budget:g}=R(i),{allocations:m,isErrorAllocations:E,isLoadingAllocations:go,errorAllocations:ho}=so({areaId:e.value,budgetYear:g}),U=C(()=>m.value?m.value.reduce((w,x)=>w+ +x.allocatedAmount,0):0);return(w,x)=>(y(),A(z,{padding:""},{default:c(()=>{var Q;return[po,M("p",Ao,"Techo Presupuestal: "+b(l(u)(((Q=l(t))==null?void 0:Q.totalAmount)||0)),1),M("p",fo,"Acumulado: "+b(l(u)(l(U)||0)),1),l(m)?(y(),A(T,{key:0,bordered:"",class:"tw-w-full lg:tw-w-1/2",separator:""},{default:c(()=>[d(q,{class:"q-pa-md bg-grey-2"},{default:c(()=>[L("Meses y Asignaciones")]),_:1}),(y(!0),O(X,null,W(l(io),p=>(y(),A(K,{key:p.id,class:"q-pa-sm"},{default:c(()=>[d(v,null,{default:c(()=>[d(q,null,{default:c(()=>[L(b(p.nombre),1)]),_:2},1024)]),_:2},1024),d(v,{side:""},{default:c(()=>{var F,I;return[d(yo,{"area-id":l(e),month:p.id,"monthly-allocation":(F=l(m))==null?void 0:F.find($=>$.month===p.id),year:(I=l(g))==null?void 0:I.year},null,8,["area-id","month","monthly-allocation","year"])]}),_:2},1024)]),_:2},1024))),128))]),_:1})):Z("",!0)]}),_:1}))}});export{To as default};
