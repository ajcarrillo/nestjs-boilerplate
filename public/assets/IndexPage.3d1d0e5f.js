import{a as I}from"./QSpace.806ddb40.js";import{b as g,a as x,c as K,Q as W,k as Y}from"./format.5c2ef003.js";import{a as M,u as Z,Q as ee}from"./useTableFilter.47a0e0b4.js";import{Q as L}from"./QList.5b32bffe.js";import{j as D,c as y,p as A,k as F,l as t,d as e,q as j,t as B,u as d,r as w,N as te,s as U,ap as z,X as h,b5 as ae,ag as le,at as ne,F as oe,b as ue,_ as ie}from"./index.3368071b.js";import{a as E,Q as se}from"./QForm.b003c7e9.js";import{Q as N}from"./QBtnGroup.2c085fd2.js";import{a as J,Q as $}from"./QTable.389e2b81.js";import{u as R,a as re}from"./useSubBudgets.f7232fd5.js";import{T as de}from"./TablePage.d279c911.js";import{g as q,f as ce}from"./QSelect.37b48709.js";import{a as G}from"./QCard.39cdd76c.js";import{Q as me}from"./QCardActions.b7416617.js";import{_ as O}from"./CardDialog.c391a448.js";import{u as fe}from"./useExportDataToCsv.b458a9cb.js";import"./scroll.0ed17dea.js";import"./use-dark.df68422f.js";import"./focus-manager.33224ae2.js";import"./QCheckbox.0e68f13b.js";import"./layout.e94e56b8.js";import"./index.2cf0d985.js";import"./QPage.1cbbdd27.js";import"./plugin-vue_export-helper.21dcd24c.js";import"./utils.esm.6355ed5c.js";import"./date.2891a3b3.js";const be=D({__name:"ShortUuidLink",props:{uuid:null,to:null},setup(b){const p=b,_=y(()=>p.uuid.substring(0,8).toUpperCase());return(v,k)=>(A(),F(x,{clickable:"",to:b.to},{default:t(()=>[e(g,null,{default:t(()=>[j(B(d(_)),1)]),_:1})]),_:1},8,["to"]))}}),ge={class:"self-center full-width no-outline",tabindex:"0"},pe={class:"self-center full-width no-outline",tabindex:"0"},_e={class:"self-center full-width no-outline",tabindex:"0"},ve=D({__name:"SubBudgetAdjustmentForm",props:{target:null},emits:["close"],setup(b,{emit:p}){const _=b,{subBudgetQuery:v}=R(),{createSubBudgetAdjustmentMutation:k}=re(),{currencyFormat:S}=M(),{data:c}=v,V=w(),a=te({source_sub_budget_id:"",target_sub_budget_id:_.target.id,justification:"",amount:0}),o=y(()=>{var u;return n.value?+((u=n.value)==null?void 0:u.amount):0}),n=y(()=>{var u;return(u=c==null?void 0:c.value)==null?void 0:u.find(s=>s.id===a.source_sub_budget_id)}),Q=y(()=>{var s;return(((s=c==null?void 0:c.value)==null?void 0:s.filter(m=>m.id!==_.target.id))||[]).map(m=>({label:m.event,value:m.id}))}),C={source_sub_budget_id:[u=>!!u||"El campo origen es requerido"],justification:[u=>!!u||"El campo justificaci\xF3n es requerido"],amount:[u=>!!u||"El campo monto es requerido",u=>u>0||"El monto debe ser mayor a 0",u=>u<=o.value||`El monto debe ser menor o igual a ${o.value}`]};async function P(){var s;await((s=V.value)==null?void 0:s.validate())&&(await k.mutateAsync({createSubBudgetAdjustmentDto:a}),p("close"))}return(u,s)=>(A(),F(d(se),{ref_key:"qSubBudgetAdjustmentForm",ref:V,onSubmit:ae(P,["prevent"])},{default:t(()=>[e(G,null,{default:t(()=>[e(L,null,{default:t(()=>[e(x,null,{default:t(()=>[e(g,null,{default:t(()=>[e(q,{dense:"",label:"Transferir al evento",outlined:"","stack-label":""},{control:t(()=>[U("div",ge,B(b.target.event),1)]),_:1})]),_:1})]),_:1}),e(x,null,{default:t(()=>[e(g,null,{default:t(()=>[e(q,{dense:"",label:"Monto",outlined:"","stack-label":""},{control:t(()=>[U("div",pe,B(d(S)(+b.target.amount)),1)]),_:1})]),_:1})]),_:1}),e(x,null,{default:t(()=>[e(g,null,{default:t(()=>[e(ce,{modelValue:a.source_sub_budget_id,"onUpdate:modelValue":s[0]||(s[0]=m=>a.source_sub_budget_id=m),dense:"","emit-value":"",label:"Origen","map-options":"",options:d(Q),outlined:"",rules:C.source_sub_budget_id},null,8,["modelValue","options","rules"])]),_:1})]),_:1}),d(n)?(A(),F(x,{key:0},{default:t(()=>[e(g,null,{default:t(()=>[e(q,{label:"Monto disponible",outlined:"","stack-label":""},{control:t(()=>[U("div",_e,B(d(S)(+d(n).amount)),1)]),_:1})]),_:1})]),_:1})):z("",!0),e(x,null,{default:t(()=>[e(g,null,{default:t(()=>[e(E,{modelValue:a.justification,"onUpdate:modelValue":s[1]||(s[1]=m=>a.justification=m),dense:"",label:"Justificaci\xF3n",outlined:"",rules:C.justification,type:"textarea"},null,8,["modelValue","rules"])]),_:1})]),_:1}),e(x,null,{default:t(()=>[e(g,null,{default:t(()=>[e(E,{modelValue:a.amount,"onUpdate:modelValue":s[2]||(s[2]=m=>a.amount=m),modelModifiers:{number:!0},dense:"",label:"Monto a transferir",max:d(o),min:1,outlined:"",rules:C.amount,step:"1",type:"number"},null,8,["modelValue","max","rules"])]),_:1})]),_:1})]),_:1})]),_:1}),e(K),e(me,{align:"right"},{default:t(()=>[e(h,{color:"primary",label:"Guardar",type:"submit"})]),_:1})]),_:1},8,["onSubmit"]))}}),Se=D({__name:"SubBudgetAdjustmentHistory",props:{subBudget:null},setup(b){const p=b,{currencyFormat:_}=M(),v=[{name:"consecutiveId",label:"ID",field:"consecutiveId",sortable:!1},{name:"signedAmount",field:a=>_(a.signedAmount),label:"Operaci\xF3n",align:"right",sortable:!1,style:a=>a.signedAmount>0?"color: green; font-weight: 700":"color: red; font-weight: 700"},{name:"event",field:a=>a.signedAmount>0?a.sourceSubBudget.event:a.targetSubBudget.event,label:"Evento",align:"left",sortable:!1},{name:"action",field:a=>{var o,n;return a.signedAmount>0?(o=a.sourceSubBudget.action)==null?void 0:o.name:(n=a.targetSubBudget.action)==null?void 0:n.name},label:"Acci\xF3n",align:"left",sortable:!1},{name:"line",field:a=>{var o,n;return a.signedAmount>0?(o=a.sourceSubBudget.line)==null?void 0:o.name:(n=a.targetSubBudget.line)==null?void 0:n.name},label:"Partida",align:"left",sortable:!1},{name:"department",field:a=>a.signedAmount>0?a.sourceSubBudget.department.description:a.targetSubBudget.department.description,label:"Departamento",align:"left",sortable:!1},{name:"justification",field:"justification",label:"Justificaci\xF3n",align:"left",sortable:!1}],k=y(()=>{var a,o;return(o=(a=p.subBudget)==null?void 0:a.adjustmentsFrom)==null?void 0:o.map(n=>({...n,signedAmount:-parseFloat(n.amount)}))}),S=y(()=>{var a,o;return(o=(a=p.subBudget)==null?void 0:a.adjustmentsTo)==null?void 0:o.map(n=>({...n,signedAmount:parseFloat(n.amount)}))}),c=y(()=>[...k.value,...S.value]),V=y(()=>c.value.sort((a,o)=>new Date(a.createdAt).getTime()-new Date(o.createdAt).getTime()));return(a,o)=>(A(),F(G,null,{default:t(()=>[e(J,{columns:v,"row-key":"id",rows:d(V),"wrap-cells":""},{"body-cell-consecutiveId":t(n=>[e($,{props:n},{default:t(()=>[j(B(n.rowIndex+1),1)]),_:2},1032,["props"])]),_:1},8,["rows"])]),_:1}))}});const Je=D({__name:"IndexPage",setup(b){const{exportDataToCsv:p}=fe(),{subBudgetQuery:_}=R(),{currencyFormat:v}=M(),{data:k}=_,S=[{name:"consecutiveId",label:"ID",field:"consecutiveId",sortable:!1,required:!0},{name:"action",label:"Acci\xF3n",field:l=>{var r;return(r=l.action)==null?void 0:r.name},align:"left",sortable:!0},{name:"line",label:"Partida",field:l=>{var r;return(r=l.line)==null?void 0:r.name},align:"left",sortable:!0},{name:"area",label:"\xC1rea",field:l=>l.department.description,align:"left",sortable:!0},{name:"benefited_population",label:"Poblaci\xF3n Beneficiada",field:"benefited_population",align:"left",sortable:!0},{name:"objective",label:"Objetivo",field:"objective",align:"left",sortable:!1},{name:"cost_per_participant",label:"Costo Por Participante",field:l=>v(+l.cost_per_participant),align:"right",sortable:!0},{name:"number_participants",label:"N\xFAm. Participantes",field:"number_participants",align:"right",sortable:!0},{name:"event",label:"Servicio o Evento",field:"event",align:"left",sortable:!0},{name:"event_venue",label:"Sede",field:"event_venue",align:"left",sortable:!0},{name:"justification",label:"Justificaci\xF3n",field:"justification",align:"left",sortable:!1},{name:"start_date",label:"Empieza",field:"start_date",align:"left",sortable:!0},{name:"end_date",label:"Termina",field:"end_date",align:"left",sortable:!0},{name:"amount",label:"$ programado",field:l=>X(l),align:"right",sortable:!0},{name:"amount",label:"$ adecuado",field:l=>v(+l.amount),align:"right",sortable:!0},{name:"vat_breakdown",label:"Desglose del I.V.A.",field:l=>l.vat_breakdown?"Si":"No",align:"left",sortable:!0},{name:"risk",label:"Riesgo",field:"risk",align:"left",sortable:!1},{name:"actions",label:"Acciones",field:"actions",sortable:!1,align:"center"}],c=w(["action","line","area","benefited_population","cost_per_participant","number_participants","event","start_date","end_date","amount","vat_breakdown","actions"]),V=S.map(l=>({label:l.label,value:l.name})).filter(l=>l.label!=="ID"),a=w(null),o=w(!1),n=w(!1),{searchQuery:Q,pagination:C,updatePagination:P}=Z(),u=w();function s(l){a.value=l,o.value=!0}function m(l){a.value=l,n.value=!0}function H(){p(u.value.filteredSortedRows,S,"sub-presupuestos")}function X(l){const r=l.adjustmentsFrom.reduce((f,T)=>f+parseFloat(T.amount),0),i=l.adjustmentsTo.reduce((f,T)=>f+parseFloat(T.amount),0);return v(+l.amount+r-i)}return(l,r)=>(A(),F(de,null,{"card-body":t(()=>[e(d(J),{ref_key:"qTableSubBudgets",ref:u,columns:S,filter:d(Q),pagination:d(C),"row-key":"id",rows:d(k),title:"Sub Presupuestos","visible-columns":c.value,"wrap-cells":"","onUpdate:pagination":d(P)},{"top-right":t(i=>[e(h,{class:"tw-mr-2",color:"primary","fab-mini":"",flat:"",icon:"tune",size:"sm"},{default:t(()=>[e(I,null,{default:t(()=>[j(" Mostrar/Ocultar columnas ")]),_:1}),e(W,{anchor:"top end",self:"center start"},{default:t(()=>[e(L,null,{default:t(()=>[(A(!0),le(oe,null,ne(d(V),f=>(A(),F(x,{key:f.value,clickable:""},{default:t(()=>[e(g,null,{default:t(()=>[e(Y,null,{default:t(()=>[j(B(f.label),1)]),_:2},1024)]),_:2},1024),e(g,{side:""},{default:t(()=>[e(ee,{modelValue:c.value,"onUpdate:modelValue":r[0]||(r[0]=T=>c.value=T),color:"primary",val:f.value},null,8,["modelValue","val"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1}),e(h,{dense:"",flat:"",icon:i.inFullscreen?"fullscreen_exit":"fullscreen",round:"",onClick:i.toggleFullscreen},{default:t(()=>[e(I,{disable:l.$q.platform.is.mobile},{default:t(()=>[j(B(i.inFullscreen?"Salir de Pantalla Completa":"Pantalla Completa"),1)]),_:2},1032,["disable"])]),_:2},1032,["icon","onClick"]),e(E,{modelValue:d(Q),"onUpdate:modelValue":r[1]||(r[1]=f=>ue(Q)?Q.value=f:null),class:"q-mr-xs",clearable:"",debounce:"300",dense:"",outlined:"",placeholder:"Buscar"},{append:t(()=>[e(ie,{name:"search"})]),_:1},8,["modelValue"]),e(N,{unelevated:""},{default:t(()=>[e(h,{color:"primary","icon-right":"archive",label:"Exportar a CSV",onClick:H})]),_:1})]),"body-cell-consecutiveId":t(i=>[e($,{props:i},{default:t(()=>[e(be,{to:{name:"sub-budgets.show",params:{id:i.row.id}},uuid:(i.rowIndex+1).toString()},null,8,["to","uuid"])]),_:2},1032,["props"])]),"body-cell-actions":t(i=>[e($,{props:i},{default:t(()=>[e(N,{rounded:"",unelevated:""},{default:t(()=>[e(h,{color:"primary",dense:"",flat:"",icon:"currency_exchange",onClick:f=>s(i.row)},{default:t(()=>[e(I,null,{default:t(()=>[j(" Adecuaci\xF3n ")]),_:1})]),_:2},1032,["onClick"]),i.row.adjustmentsFrom.length>0||i.row.adjustmentsTo.length>0?(A(),F(h,{key:0,color:"info",dense:"",flat:"",icon:"history",onClick:f=>m(i.row)},{default:t(()=>[e(I,null,{default:t(()=>[j(" Ver adecuaciones ")]),_:1})]),_:2},1032,["onClick"])):z("",!0)]),_:2},1024)]),_:2},1032,["props"])]),_:1},8,["filter","pagination","rows","visible-columns","onUpdate:pagination"])]),footer:t(()=>[e(O,{modelValue:o.value,"onUpdate:modelValue":r[2]||(r[2]=i=>o.value=i),"card-title":"Adecuaci\xF3n"},{default:t(({closeDialog:i})=>[e(ve,{target:a.value,onClose:i},null,8,["target","onClose"])]),_:1},8,["modelValue"]),e(O,{modelValue:n.value,"onUpdate:modelValue":r[3]||(r[3]=i=>n.value=i),"card-title":"Historial de Adecuaciones",class:"card-size-dialog"},{default:t(()=>[e(Se,{"sub-budget":a.value},null,8,["sub-budget"])]),_:1},8,["modelValue"])]),_:1}))}});export{Je as default};
