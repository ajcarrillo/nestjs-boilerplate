import{Q as oe}from"./QSpace.62bbc7da.js";import{Q as le}from"./QToggle.3e6ba614.js";import{j as Z,r as b,M as ee,p as w,k as F,l as t,d as e,u as h,_ as R,X as S,b9 as se,o as ue,w as H,c as ie,V as de,m as me,s as pe,t as Y,q as K,aj as _e,O as ce}from"./index.e2638eb4.js";import{l as D,Q as x}from"./layout.b48f6ca2.js";import{a as fe,Q as W}from"./QTable.71f78e09.js";import{Q as be}from"./QPage.c2fef450.js";import{T as ye}from"./TablePage.c13247da.js";import{p as $}from"./planeacion.api.4718394d.js";import{u as ge,a as te}from"./QChip.e0f21080.js";import{u as ae}from"./useMutation.esm.7ab5810a.js";import{_ as ve}from"./CardDialog.cb32ff35.js";import{Q as c,a as f}from"./QItemLabel.9891a74a.js";import{Q as he}from"./QSelect.8f3e200a.js";import{Q as Ve}from"./QCheckbox.b1850863.js";import{Q as X}from"./QFile.2bb28d4c.js";import{Q as Pe}from"./QList.9bbd2c21.js";import{Q as ke}from"./QCardSection.94464a72.js";import{a as Oe}from"./format.c4cd2b11.js";import{Q as we}from"./QCardActions.771e2101.js";import{Q as Fe}from"./QForm.e216d907.js";import{c as j}from"./index.7adaf3a2.js";import{_ as Qe}from"./DatePicker.9480aac9.js";import{b as qe}from"./usePurchaseOrders.ff26eee5.js";import{F as xe}from"./FilePreview.15041e1a.js";import{d as Se}from"./date.5b07776c.js";import{u as De}from"./useMoney.dbc60660.js";import"./use-dark.eb190f4a.js";import"./scroll.28522c71.js";import"./QCard.be8ff39f.js";import"./plugin-vue_export-helper.21dcd24c.js";import"./index.2cf0d985.js";import"./utils.esm.7ac9ce6f.js";import"./mutation.esm.6f8cd676.js";import"./QPopupProxy.c515cd9f.js";import"./ClosePopup.e552dc18.js";import"./QTooltip.5f4d8a67.js";import"./QImg.39e45ba0.js";function J(a){const r=new FormData;return r.append("payment_number",a.payment_number),r.append("payment_date",a.payment_date),r.append("amount",a.amount.toString()),r.append("purchase_order_id",a.purchase_order_id),r.append("check_number",a.check_number||""),r.append("is_submitted_to_finance",a.is_submitted_to_finance),a.paymentFile&&r.append("payment_file",a.paymentFile),a.checkFile&&r.append("check_file",a.checkFile),r}var L={getPaymentOrders({show:a}){console.log({show:a});const r=a===!1?"presupuestos":"subpresupuestos";return $.get(`/payment-orders?show=${r}`)},storePaymentOrder(a){const r=J(a);return $.post("/payment-orders",r,{headers:{"Content-Type":"multipart/form-data"}})},updatePaymentOrder(a){const{...r}=a,{id:y}=r;delete r.id;const V=J(r);return $.patch(`/payment-orders/${y}`,V,{headers:{"Content-Type":"multipart/form-data"}})}};const Ie=async({show:a})=>(await L.getPaymentOrders({show:a})).data,Ce=async a=>(await L.storePaymentOrder(a)).data,Me=async a=>(await L.updatePaymentOrder(a)).data,Ne=({show:a})=>({queryPaymentOrders:ge({queryKey:["paymentOrders",{show:a}],queryFn:()=>Ie({show:a.value}),staleTime:6e4})}),Ue=()=>{const a=te();return{storePaymentOrderMutation:ae({mutationFn:Ce,onSuccess:async()=>{await a.invalidateQueries(["paymentOrders"]),D.showSuccessNotification("Orden de pago creada")},onError:()=>{D.showErrorNotification("No se pudo crear la orden de pago")}})}},Ae=()=>{const a=te();return{updatePaymentOrderMutation:ae({mutationFn:Me,onSuccess:async()=>{await a.invalidateQueries(["paymentOrders"]),D.showSuccessNotification("Orden de pago actualizada")},onError:()=>{D.showErrorNotification("No se pudo actualizar la orden de pago")}})}},Ee=Z({__name:"PaymentOrderForm",props:{paymentOrder:{default:()=>({purchase_order_id:"",payment_number:"",amount:0,payment_date:new Date().toISOString().substring(0,10),payment_file:"",check_number:"",check_file:"",is_submitted_to_finance:!1})}},emits:["close"],setup(a,{emit:r}){const y=a,V="https://nestjs-boilerplate-production.up.railway.app",{storePaymentOrderMutation:_}=Ue(),{updatePaymentOrderMutation:P}=Ae(),{dictionary:I}=qe(),g=b(),z={purchase_order_id:"",payment_number:"",amount:0,payment_date:new Date().toISOString().substring(0,10),payment_file:"",check_number:"",check_file:"",is_submitted_to_finance:!1},n=ee(j(y.paymentOrder)||j(z)),v={purchase_order_id:[l=>!!l||"La orden de compra es requerida"],payment_number:[l=>!!l||"El n\xFAmero de pago es requerido",l=>l.length==3||"El n\xFAmero de pago debe tener 3 d\xEDgitos",l=>!isNaN(Number(l))||"El n\xFAmero de pago debe ser un n\xFAmero"],amount:[l=>!!l||"El monto es requerido",l=>!isNaN(Number(l))||"El monto debe ser un n\xFAmero"],payment_date:[l=>!!l||"La fecha de pago es requerida"]},m=b(),p=b();async function Q(){var s,o;await((s=g.value)==null?void 0:s.validate())&&(n.hasOwnProperty("id")?await P.mutateAsync(n):(await _.mutateAsync(n),(o=g.value)==null||o.reset(),r("close")))}function k(){n.purchase_order_id="",n.payment_number="",n.amount=0,n.payment_date=new Date().toISOString().substring(0,10),n.payment_file="",n.check_number="",n.check_file="",n.is_submitted_to_finance=!1,m.value=void 0,p.value=void 0}function C(l){n.paymentFile=l}function O(l){n.checkFile=l}return(l,s)=>(w(),F(h(Fe),{ref_key:"qPaymentOrderForm",ref:g,onReset:k,onSubmit:se(Q,["prevent"])},{default:t(()=>[e(ke,null,{default:t(()=>[e(Pe,null,{default:t(()=>[e(c,null,{default:t(()=>[e(f,null,{default:t(()=>[e(x,{modelValue:n.payment_number,"onUpdate:modelValue":s[0]||(s[0]=o=>n.payment_number=o),dense:"",label:"N\xFAmero de pago",outlined:"",rules:v.payment_number},null,8,["modelValue","rules"])]),_:1})]),_:1}),e(c,null,{default:t(()=>[e(f,null,{default:t(()=>[e(Qe,{modelValue:n.payment_date,"onUpdate:modelValue":s[1]||(s[1]=o=>n.payment_date=o),rules:v.payment_date},null,8,["modelValue","rules"])]),_:1})]),_:1}),e(c,null,{default:t(()=>[e(f,null,{default:t(()=>[e(x,{modelValue:n.amount,"onUpdate:modelValue":s[2]||(s[2]=o=>n.amount=o),modelModifiers:{number:!0},dense:"",label:"Monto",outlined:"",rules:v.amount},null,8,["modelValue","rules"])]),_:1})]),_:1}),e(c,null,{default:t(()=>[e(f,null,{default:t(()=>[e(he,{modelValue:n.purchase_order_id,"onUpdate:modelValue":s[3]||(s[3]=o=>n.purchase_order_id=o),dense:"","emit-value":"",label:"Orden de compra","map-options":"",options:h(I),outlined:"",rules:v.purchase_order_id},null,8,["modelValue","options","rules"])]),_:1})]),_:1}),e(c,null,{default:t(()=>[e(f,null,{default:t(()=>[e(Ve,{modelValue:n.is_submitted_to_finance,"onUpdate:modelValue":s[4]||(s[4]=o=>n.is_submitted_to_finance=o),dense:"",label:"\xBFSe envi\xF3 a finanzas?",outlined:""},null,8,["modelValue"])]),_:1})]),_:1}),e(c,null,{default:t(()=>[e(f,null,{default:t(()=>[n.payment_file?(w(),F(xe,{key:1,"file-url":`${h(V)}/api/files/payment-orders/${n.id}/${n.payment_file}`},{activator:t(({showPreview:o})=>[e(S,{color:"primary",dense:"",flat:"",icon:"visibility",label:"Ver archivo de pago",unelevated:"",onClick:o},null,8,["onClick"])]),_:1},8,["file-url"])):(w(),F(X,{key:0,modelValue:m.value,"onUpdate:modelValue":[s[5]||(s[5]=o=>m.value=o),C],accept:".jpg, image/*, application/pdf",dense:"",label:"Archivo de pago",loading:!1,name:"payment_file",outlined:"","use-chips":""},{prepend:t(()=>[e(R,{name:"attach_file"})]),_:1},8,["modelValue"]))]),_:1})]),_:1}),e(c,null,{default:t(()=>[e(f,null,{default:t(()=>[e(x,{modelValue:n.check_number,"onUpdate:modelValue":s[6]||(s[6]=o=>n.check_number=o),dense:"",label:"N\xFAmero de cheque",outlined:""},null,8,["modelValue"])]),_:1})]),_:1}),e(c,null,{default:t(()=>[e(f,null,{default:t(()=>[e(X,{modelValue:p.value,"onUpdate:modelValue":[s[7]||(s[7]=o=>p.value=o),O],accept:".jpg, image/*, application/pdf",dense:"",label:"Archivo de cheque",loading:!1,name:"check_file",outlined:"","use-chips":""},{prepend:t(()=>[e(R,{name:"attach_file"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),e(Oe),e(we,{align:"right"},{default:t(()=>[e(S,{color:"primary",label:"Guardar",type:"submit"})]),_:1})]),_:1},8,["onSubmit"]))}});const Te={class:"q-table__title"},B=Se.formatDate,kt=Z({__name:"IndexPage",setup(a){const r=de(),y=me(),V=y.query.show||"presupuestos",_=b(V==="subpresupuestos"),{currencyFormat:P}=De(),{queryPaymentOrders:I}=Ne({show:_}),{data:g,isLoading:z,isError:n}=I,v=[{name:"consecutiveId",label:"ID",field:"consecutiveId",sortable:!1,required:!0},{name:"a_description",field:"a_description",label:"Departamento",align:"left",sortable:!0},{name:"sb_event",field:"sb_event",label:"Evento",sortable:!1,align:"left"},{name:"po_payment_number",field:"po_payment_number",label:"Orden de pago",align:"right",sortable:!0},{name:"po_amount",field:u=>P(+u.po_amount),label:"Total real",align:"right",sortable:!0},{name:"po_payment_date",field:u=>B(u.po_payment_date,"YYYY-MM-DD"),label:"Fecha de pago",align:"center",sortable:!0},{name:"por_order_number",field:"por_order_number",label:"Orden de compra",align:"right",sortable:!0},{name:"por_reception_date",field:u=>B(u.por_reception_date,"YYYY-MM-DD"),label:"Orden de compra fecha de recepci\xF3n",align:"center",sortable:!0},{name:"r_requisition_number",field:"r_requisition_number",label:"Requisici\xF3n",align:"right",sortable:!0},{name:"r_estimated_amount",field:u=>P(+u.r_estimated_amount),label:"Estimado",align:"right",sortable:!0},{name:"rsb_requisition_number",field:"rsb_requisition_number",label:"Requisici\xF3n",align:"right",sortable:!0},{name:"rsb_estimated_amount",field:u=>P(+u.rsb_estimated_amount),label:"Estimado",align:"right",sortable:!0}],m=b(["a_description","po_payment_number","po_amount","po_payment_date","por_order_number","por_reception_date","r_requisition_number","r_estimated_amount"]),p=b(!1),Q=b(-1);let k=ee({purchase_order_id:"",payment_number:"",amount:0,payment_date:new Date().toISOString().substring(0,10),payment_file:"",check_number:"",check_file:"",is_submitted_to_finance:!1});const C={purchase_order_id:"",payment_number:"",amount:0,payment_date:new Date().toISOString().substring(0,10),payment_file:"",check_number:"",check_file:"",is_submitted_to_finance:!1},O=b("");ue(()=>{_.value&&(m.value.splice(1,0,"sb_event"),m.value.splice(7,2,"rsb_requisition_number","rsb_estimated_amount"))}),H(p,u=>{u||o()}),H(_,u=>{r.replace({query:{...y.query,show:u?"subpresupuestos":"presupuestos"}}),u?(m.value.splice(1,0,"sb_event"),m.value.splice(7,2,"rsb_requisition_number","rsb_estimated_amount")):(m.value.splice(1,1),m.value.splice(6,2,"r_requisition_number","r_estimated_amount"))});const l=ie(()=>_.value?"\xD3rdenes de pago/SubPresupuestos":"\xD3rdenes de pago/Presupuestos");function s(u){var G;const{payment_number:d,amount:i,payment_date:q,payment_file:M,check_number:N,check_file:U,id:A,is_submitted_to_finance:E,purchase_order_id:T}=ne(u);Q.value=(G=g.value)==null?void 0:G.findIndex(re=>re.po_id===u.po_id),k=Object.assign({},{id:A,purchase_order_id:T,payment_number:d,amount:i,payment_date:q,payment_file:M,check_number:N,check_file:U,is_submitted_to_finance:E}),p.value=!0}function o(){p.value=!1,ce(()=>{k=j(C),Q.value=-1})}function ne(u){const{po_payment_number:d,po_amount:i,po_payment_date:q,po_payment_file:M,po_check_number:N,po_check_file:U,po_id:A,po_is_submitted_to_finance:E,po_purchase_order_id:T}=u;return{id:A,purchase_order_id:T,payment_number:d,amount:+i,payment_date:B(q,"YYYY-MM-DD"),payment_file:M,check_number:N,check_file:U,is_submitted_to_finance:E}}return(u,d)=>(w(),F(be,null,{default:t(()=>[e(ye,null,{"card-body":t(()=>[e(fe,{columns:v,filter:O.value,flat:"",pagination:{rowsPerPage:20},rows:h(g),"visible-columns":m.value,"wrap-cells":""},{top:t(()=>[pe("div",Te,Y(h(l)),1),e(oe),e(le,{modelValue:_.value,"onUpdate:modelValue":d[0]||(d[0]=i=>_.value=i),class:"tw-mr-4",label:"Mostrar las \xF3rdenes de pago de los SubPresupuestos"},null,8,["modelValue"]),e(x,{modelValue:O.value,"onUpdate:modelValue":d[1]||(d[1]=i=>O.value=i),class:"q-mr-xs",clearable:"",debounce:"300",dense:"",outlined:"",placeholder:"Buscar"},{append:t(()=>[e(R,{name:"search"})]),_:1},8,["modelValue"]),e(S,{color:"primary",label:"Nueva orden de pago",onClick:d[2]||(d[2]=i=>p.value=!0)})]),"body-cell-consecutiveId":t(i=>[e(W,{props:i},{default:t(()=>[K(Y((i.rowIndex+1).toString()),1)]),_:2},1032,["props"])]),"body-cell-po_payment_number":t(i=>[e(W,{props:i},{default:t(()=>[i.value?(w(),F(S,{key:0,color:"primary",flat:"","no-caps":"",onClick:q=>s(i.row)},{default:t(()=>[K(Y(i.value),1)]),_:2},1032,["onClick"])):_e("",!0)]),_:2},1032,["props"])]),_:1},8,["filter","rows","visible-columns"])]),footer:t(()=>[e(ve,{modelValue:p.value,"onUpdate:modelValue":d[3]||(d[3]=i=>p.value=i),"card-title":"Orden de pago",class:"form-payment-order"},{default:t(({closeDialog:i})=>[e(Ee,{"payment-order":h(k),onClose:i},null,8,["payment-order","onClose"])]),_:1},8,["modelValue"])]),_:1})]),_:1}))}});export{kt as default};
