import{Q as v}from"./QItemLabel.f1939688.js";import{Q as R,a as S}from"./QItem.dd8e4c40.js";import{Q as T}from"./QList.1c19b31b.js";import{Q as z}from"./QPage.7ce3cb7c.js";import{A as P}from"./AreaAllocationResource.4aa26ec2.js";import{u as B,a as C}from"./useQuery.esm.dd222c7d.js";import{b as D}from"./useBudgets.7ad2ff86.js";import{u as J}from"./useMoney.dbc60660.js";import{p as b}from"./BudgetResource.6b2552bc.js";import{c as N,j as k,M as Y,r as j,p as y,k as f,l as u,d,u as l,ba as G,m as H,bc as O,s as E,t as M,q as L,ae as W,ai as X,F as Z,ah as oo}from"./index.98b8b759.js";import{Q as to}from"./QInput.654fe12c.js";import{c as eo}from"./index.7adaf3a2.js";import{Q as ao}from"./QForm.cd1920aa.js";import{a as V}from"./index.2cf0d985.js";import{l as g}from"./layout.893a0074.js";import{u as $}from"./useMutation.esm.70a0cd22.js";import"./use-dark.e1c6b971.js";import"./utils.esm.b39882c3.js";import"./use-key-composition.9c45f4e0.js";import"./focus-manager.387b0375.js";import"./mutation.esm.5a13a832.js";const no=async({budgetId:t,areaId:o})=>{const{data:a}=await P.getAreaAllocationByuBudgetIdAndAreaId({budgetId:t,areaId:o});return a},ro=({budgetId:t,areaId:o})=>{const{isLoading:a,isError:i,data:e,error:r}=B({queryKey:["area-allocation-by-budget-and-area",t,o],queryFn:()=>no({budgetId:t,areaId:o}),staleTime:6e5,retry:(s,n)=>{var m;return((m=n==null?void 0:n.response)==null?void 0:m.status)!==404}});return{isLoading:a,isError:i,data:e,error:r}};var _={getMonthlyAllocations(t,o){return b.get(`/monthly-area-allocation/${t}?budgetYear=${o}`)},storeMonthlyAllocation(t){return b.post(`/monthly-area-allocation?budgetYear=${t.year}`,t)},updateMonthlyAllocation(t,o){return b.patch(`/monthly-area-allocation/${t}`,{allocatedAmount:o.allocatedAmount})}};const so=async(t,o)=>{const{data:a}=await _.getMonthlyAllocations(t,o);return a},io=({areaId:t,budgetYear:o})=>{const a=N(()=>!!t&&!!o.value),{isLoading:i,isError:e,data:r,error:s}=B({queryKey:["monthly-area-allocations",t],queryFn:()=>{var n;return so(t,(n=o.value)==null?void 0:n.year)},enabled:a,staleTime:1e3*60*10});return{isLoadingAllocations:i,isErrorAllocations:e,allocations:r,errorAllocations:s}},lo=[{id:1,nombre:"Enero"},{id:2,nombre:"Febrero"},{id:3,nombre:"Marzo"},{id:4,nombre:"Abril"},{id:5,nombre:"Mayo"},{id:6,nombre:"Junio"},{id:7,nombre:"Julio"},{id:8,nombre:"Agosto"},{id:9,nombre:"Septiembre"},{id:10,nombre:"Octubre"},{id:11,nombre:"Noviembre"},{id:12,nombre:"Diciembre"}],co=async t=>{const{data:o}=await _.storeMonthlyAllocation(t);return o},uo=()=>{const t=C(),{mutateAsync:o,isLoading:a,isError:i}=$({mutationFn:co,onSuccess:async e=>{await t.invalidateQueries({queryKey:["monthly-area-allocations",e.areaId]}),g.showSuccessNotification("Asignacion creada con \xE9xito")},onError:e=>{let r="Error al crear asignaci\xF3n.";if(V.isAxiosError(e)){const s=e;if(s.response){const n=s.response.data;(s.response.status===400&&n.message||n.message)&&(r=n.message)}else s.message&&(r=s.message)}else e instanceof Error&&(r=e.message);g.showErrorNotification(r)}});return{createMonthlyAllocationMutation:o,isLoading:a,isError:i}},mo=async t=>{const{data:o}=await _.updateMonthlyAllocation(t.uuid,t);return o},yo=()=>{const t=C(),{mutateAsync:o,isLoading:a,isError:i}=$({mutationFn:mo,onSuccess:async e=>{await t.invalidateQueries({queryKey:["monthly-area-allocations",e.areaId]}),g.showSuccessNotification("Asignacion actualizada con \xE9xito")},onError:e=>{let r="Error al actualizar asignaci\xF3n.";if(V.isAxiosError(e)){const s=e;if(s.response){const n=s.response.data;(s.response.status===400&&n.message||n.message)&&(r=n.message)}else s.message&&(r=s.message)}else e instanceof Error&&(r=e.message);g.showErrorNotification(r)}});return{updateMonthlyAllocationMutation:o,isUpdating:a,isError:i}},po=k({__name:"MonthlyAllocationForm",props:{monthlyAllocation:{default:()=>({areaId:"",month:0,year:0,allocatedAmount:0,uuid:""})},month:null,year:null,areaId:null},setup(t){const o=t,a=Y(eo(o.monthlyAllocation)),i=j(),{createMonthlyAllocationMutation:e,isLoading:r}=uo(),{updateMonthlyAllocationMutation:s,isUpdating:n}=yo(),m=async()=>{o.monthlyAllocation.uuid?await s({uuid:o.monthlyAllocation.uuid,allocatedAmount:a.allocatedAmount.toString()}):await e({areaId:o.areaId,month:o.month,year:o.year,allocatedAmount:a.allocatedAmount.toString()})},p=[c=>c>=0||"Solo se permiten n\xFAmeros positivos",c=>/^\d+(\.\d{1,2})?$/.test(c)||"Solo se permiten m\xE1ximo dos decimales y un punto decimal"];return(c,h)=>(y(),f(l(ao),{ref_key:"qAllocationForm",ref:i,onSubmit:G(m,["prevent"])},{default:u(()=>[d(to,{modelValue:a.allocatedAmount,"onUpdate:modelValue":h[0]||(h[0]=x=>a.allocatedAmount=x),modelModifiers:{number:!0},dense:"",disable:l(r)||l(n),hint:"Presione enter para guardar","input-class":"text-right",label:"Monto Asignado",outlined:"",prefix:"$",rules:p,type:"text"},null,8,["modelValue","disable"])]),_:1},8,["onSubmit"]))}}),Ao=E("h4",{class:"text-h4"},"Asignaciones",-1),fo={class:"tw-font-semibold tw-text-gray-700"},go={class:"tw-font-semibold tw-text-gray-700"},Ro=k({__name:"Index",setup(t){const o=H(),{userAreaId:a}=O(),{budgetId:i}=o.params,{data:e,isLoading:r,isError:s,error:n}=ro({budgetId:i,areaId:a.value}),{currencyFormat:m}=J(),{budget:p}=D(i),{allocations:c,isErrorAllocations:h,isLoadingAllocations:x,errorAllocations:ho}=io({areaId:a.value,budgetYear:p}),U=N(()=>c.value?c.value.reduce((w,Q)=>w+ +Q.allocatedAmount,0):0);return(w,Q)=>(y(),f(z,{padding:""},{default:u(()=>{var F;return[Ao,E("p",fo,"Techo Presupuestal: "+M(l(m)(((F=l(e))==null?void 0:F.totalAmount)||0)),1),E("p",go,"Acumulado: "+M(l(m)(l(U)||0)),1),l(c)?(y(),f(T,{key:0,bordered:"",class:"tw-w-full lg:tw-w-1/2",separator:""},{default:u(()=>[d(v,{class:"q-pa-md bg-grey-2"},{default:u(()=>[L("Meses y Asignaciones")]),_:1}),(y(!0),W(Z,null,X(l(lo),A=>(y(),f(R,{key:A.id,class:"q-pa-sm"},{default:u(()=>[d(S,null,{default:u(()=>[d(v,null,{default:u(()=>[L(M(A.nombre),1)]),_:2},1024)]),_:2},1024),d(S,{side:""},{default:u(()=>{var I,q;return[d(po,{"area-id":l(a),month:A.id,"monthly-allocation":(I=l(c))==null?void 0:I.find(K=>K.month===A.id),year:(q=l(p))==null?void 0:q.year},null,8,["area-id","month","monthly-allocation","year"])]}),_:2},1024)]),_:2},1024))),128))]),_:1})):oo("",!0)]}),_:1}))}});export{Ro as default};
