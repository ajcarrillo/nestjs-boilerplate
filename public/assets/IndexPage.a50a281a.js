import{Q as ye}from"./QSpace.1bee90fa.js";import{Q as be}from"./QToggle.e125aaf0.js";import{S as ge,j as re,r as m,M as le,p as Q,k as x,l as t,d as e,u as _,_ as K,X as w,b9 as ve,o as he,w as te,c as we,V as Oe,m as Pe,s as Ve,t as z,q as G,aj as ke,O as Fe}from"./index.2447aa50.js";import{l as O,Q as N}from"./layout.6863befb.js";import{a as Qe,Q as I}from"./QTable.697eb207.js";import{Q as xe}from"./QBanner.0ec551cc.js";import{Q as se}from"./QCardSection.4dd5e4e8.js";import{Q as Se}from"./QPage.0cca4af3.js";import{T as qe}from"./TablePage.ec715fb1.js";import{p as M,u as De}from"./planeacion.api.88477cd4.js";import{u as Ce,a as X}from"./useQuery.esm.750a8d8b.js";import{u as J}from"./useMutation.esm.74dfadc9.js";import{_ as ae}from"./CardDialog.c2bfa875.js";import{Q as b,a as g,c as Ie}from"./QSelect.2537b62b.js";import{Q as Me}from"./QCheckbox.06660279.js";import{Q as ne}from"./QFile.667b126a.js";import{Q as Ne}from"./QList.faf37d42.js";import{a as Ae}from"./format.267f291d.js";import{Q as Ue}from"./QCardActions.905e0fb8.js";import{Q as Ee}from"./QForm.63b1cacd.js";import{c as W}from"./index.7adaf3a2.js";import{_ as $e}from"./DatePicker.4876206b.js";import{c as Te}from"./usePurchaseOrders.b052d250.js";import{F as ie}from"./FilePreview.57a0eabd.js";import{d as Ye}from"./date.5cf3ae7e.js";import{u as Be}from"./useMoney.dbc60660.js";import"./use-dark.d5768ce8.js";import"./scroll.b3c06f66.js";import"./QCard.bb46903a.js";import"./plugin-vue_export-helper.21dcd24c.js";import"./index.2cf0d985.js";import"./utils.esm.d89223b6.js";import"./mutation.esm.b316ef31.js";import"./MyCardTitle.048c6803.js";import"./QPopupProxy.b7486451.js";import"./ClosePopup.c4620041.js";import"./QTooltip.b76f4e81.js";import"./QImg.85161e06.js";function oe(a){const n=new FormData;return n.append("payment_number",a.payment_number),n.append("payment_date",a.payment_date),n.append("amount",a.amount.toString()),n.append("purchase_order_id",a.purchase_order_id),n.append("check_number",a.check_number||""),n.append("is_submitted_to_finance",a.is_submitted_to_finance),a.paymentFile&&n.append("payment_file",a.paymentFile),a.checkFile&&n.append("check_file",a.checkFile),n}var A={getPaymentOrders({show:a}){const n=a===!1?"presupuestos":"subpresupuestos";return M.get(`/payment-orders?show=${n}`)},storePaymentOrder(a){const n=oe(a);return M.post("/payment-orders",n,{headers:{"Content-Type":"multipart/form-data"}})},updatePaymentOrder(a){const{...n}=a,{id:f}=n;delete n.id;const v=oe(n);return M.patch(`/payment-orders/${f}`,v,{headers:{"Content-Type":"multipart/form-data"}})},deletePaymentOrder(a){return M.delete(`/payment-orders/${a}`)}};const Re=async({show:a})=>(await A.getPaymentOrders({show:a})).data,je=async a=>(await A.storePaymentOrder(a)).data,Le=async a=>(await A.updatePaymentOrder(a)).data,ze=async({id:a})=>(await A.deletePaymentOrder(a)).data,Ge=({show:a})=>{const n=De(),{selectedBudget:f}=ge(n);return{queryPaymentOrders:Ce({queryKey:["paymentOrders",a,f],queryFn:()=>Re({show:a.value}),staleTime:1e3*60})}},He=()=>{const a=X();return{storePaymentOrderMutation:J({mutationFn:je,onSuccess:async()=>{await a.invalidateQueries(["paymentOrders"]),O.showSuccessNotification("Orden de pago creada")},onError:()=>{O.showErrorNotification("No se pudo crear la orden de pago")}})}},Ke=()=>{const a=X();return{updatePaymentOrderMutation:J({mutationFn:Le,onSuccess:async()=>{await a.invalidateQueries(["paymentOrders"]),O.showSuccessNotification("Orden de pago actualizada")},onError:()=>{O.showErrorNotification("No se pudo actualizar la orden de pago")}})}},We=({show:a})=>{const n=X();return{deletePaymentOrderMutation:J({mutationFn:ze,onSuccess:async()=>{await n.invalidateQueries(["paymentOrders",{show:a}]),O.showSuccessNotification("Orden de pago eliminada")},onError:()=>{O.showErrorNotification("No se pudo eliminar la orden de pago")}})}},Xe=re({__name:"PaymentOrderForm",props:{paymentOrder:{default:()=>({purchase_order_id:"",payment_number:"",amount:0,payment_date:new Date().toISOString().substring(0,10),payment_file:"",check_number:"",check_file:"",is_submitted_to_finance:!1})}},emits:["close"],setup(a,{emit:n}){const f=a,v="https://nestjs-boilerplate-production.up.railway.app",{storePaymentOrderMutation:U}=He(),{updatePaymentOrderMutation:p}=Ke(),{dictionary:P}=Te(),V=m(),S={purchase_order_id:"",payment_number:"",amount:0,payment_date:new Date().toISOString().substring(0,10),payment_file:"",check_number:"",check_file:"",is_submitted_to_finance:!1},o=le(W(f.paymentOrder)||W(S)),h={purchase_order_id:[s=>!!s||"La orden de compra es requerida"],payment_number:[s=>!!s||"El n\xFAmero de pago es requerido",s=>s.length<=4||"El n\xFAmero de pago debe tener 4 d\xEDgitos",s=>!isNaN(Number(s))||"El n\xFAmero de pago debe ser un n\xFAmero"],amount:[s=>!!s||"El monto es requerido",s=>!isNaN(Number(s))||"El monto debe ser un n\xFAmero"],payment_date:[s=>!!s||"La fecha de pago es requerida"]},k=m(),q=m();async function E(){var u,l;await((u=V.value)==null?void 0:u.validate())&&(o.hasOwnProperty("id")?await p.mutateAsync(o):(await U.mutateAsync(o),(l=V.value)==null||l.reset(),n("close")))}function c(){o.purchase_order_id="",o.payment_number="",o.amount=0,o.payment_date=new Date().toISOString().substring(0,10),o.payment_file="",o.check_number="",o.check_file="",o.is_submitted_to_finance=!1,k.value=void 0,q.value=void 0}function y(s){o.paymentFile=s}function D(s){o.checkFile=s}return(s,u)=>(Q(),x(_(Ee),{ref_key:"qPaymentOrderForm",ref:V,onReset:c,onSubmit:ve(E,["prevent"])},{default:t(()=>[e(se,null,{default:t(()=>[e(Ne,null,{default:t(()=>[e(b,null,{default:t(()=>[e(g,null,{default:t(()=>[e(N,{modelValue:o.payment_number,"onUpdate:modelValue":u[0]||(u[0]=l=>o.payment_number=l),dense:"",label:"N\xFAmero de pago",outlined:"",rules:h.payment_number},null,8,["modelValue","rules"])]),_:1})]),_:1}),e(b,null,{default:t(()=>[e(g,null,{default:t(()=>[e($e,{modelValue:o.payment_date,"onUpdate:modelValue":u[1]||(u[1]=l=>o.payment_date=l),rules:h.payment_date},null,8,["modelValue","rules"])]),_:1})]),_:1}),e(b,null,{default:t(()=>[e(g,null,{default:t(()=>[e(N,{modelValue:o.amount,"onUpdate:modelValue":u[2]||(u[2]=l=>o.amount=l),modelModifiers:{number:!0},dense:"",label:"Monto",outlined:"",rules:h.amount},null,8,["modelValue","rules"])]),_:1})]),_:1}),e(b,null,{default:t(()=>[e(g,null,{default:t(()=>[e(Ie,{modelValue:o.purchase_order_id,"onUpdate:modelValue":u[3]||(u[3]=l=>o.purchase_order_id=l),dense:"","emit-value":"",label:"Orden de compra","map-options":"",options:_(P),outlined:"",rules:h.purchase_order_id},null,8,["modelValue","options","rules"])]),_:1})]),_:1}),e(b,null,{default:t(()=>[e(g,null,{default:t(()=>[e(Me,{modelValue:o.is_submitted_to_finance,"onUpdate:modelValue":u[4]||(u[4]=l=>o.is_submitted_to_finance=l),dense:"",label:"\xBFSe envi\xF3 a finanzas?",outlined:""},null,8,["modelValue"])]),_:1})]),_:1}),e(b,null,{default:t(()=>[e(g,null,{default:t(()=>[o.payment_file?(Q(),x(ie,{key:1,"file-url":`${_(v)}/api/files/payment-orders/${o.id}/${o.payment_file}`},{activator:t(({showPreview:l})=>[e(w,{color:"primary",dense:"",flat:"",icon:"visibility",label:"Ver archivo de pago",unelevated:"",onClick:l},null,8,["onClick"])]),_:1},8,["file-url"])):(Q(),x(ne,{key:0,modelValue:k.value,"onUpdate:modelValue":[u[5]||(u[5]=l=>k.value=l),y],accept:".jpg, image/*, application/pdf",dense:"",label:"Archivo de pago",loading:!1,name:"payment_file",outlined:"","use-chips":""},{prepend:t(()=>[e(K,{name:"attach_file"})]),_:1},8,["modelValue"]))]),_:1})]),_:1}),e(b,null,{default:t(()=>[e(g,null,{default:t(()=>[e(N,{modelValue:o.check_number,"onUpdate:modelValue":u[6]||(u[6]=l=>o.check_number=l),dense:"",label:"N\xFAmero de cheque",outlined:""},null,8,["modelValue"])]),_:1})]),_:1}),e(b,null,{default:t(()=>[e(g,null,{default:t(()=>[e(ne,{modelValue:q.value,"onUpdate:modelValue":[u[7]||(u[7]=l=>q.value=l),D],accept:".jpg, image/*, application/pdf",dense:"",label:"Archivo de cheque",loading:!1,name:"check_file",outlined:"","use-chips":""},{prepend:t(()=>[e(K,{name:"attach_file"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),e(Ae),e(Ue,{align:"right"},{default:t(()=>[e(w,{color:"primary",label:"Guardar",type:"submit"})]),_:1})]),_:1},8,["onSubmit"]))}});const Je={class:"q-table__title"},H=Ye.formatDate,Ut=re({__name:"IndexPage",setup(a){const n="https://nestjs-boilerplate-production.up.railway.app",f=Oe(),v=Pe(),U=v.query.show||"presupuestos",p=m(U==="subpresupuestos"),{currencyFormat:P}=Be(),{queryPaymentOrders:V}=Ge({show:p}),{deletePaymentOrderMutation:S}=We({show:p}),{isLoading:o}=S,{data:h,isLoading:k,isError:q}=V,E=[{name:"consecutiveId",label:"ID",field:"consecutiveId",sortable:!1,required:!0},{name:"a_description",field:"a_description",label:"Departamento",align:"left",sortable:!0},{name:"sb_event",field:"sb_event",label:"Evento",sortable:!1,align:"left"},{name:"po_payment_number",field:"po_payment_number",label:"Orden de pago",align:"right",sortable:!0},{name:"po_amount",field:i=>P(+i.po_amount),label:"Total real",align:"right",sortable:!0},{name:"po_payment_date",field:i=>H(i.po_payment_date,"YYYY-MM-DD"),label:"Fecha de pago",align:"center",sortable:!0},{name:"por_order_number",field:"por_order_number",label:"Orden de compra",align:"right",sortable:!0},{name:"por_reception_date",field:i=>H(i.por_reception_date,"YYYY-MM-DD"),label:"Orden de compra fecha de recepci\xF3n",align:"center",sortable:!0},{name:"r_requisition_number",field:"r_requisition_number",label:"Requisici\xF3n",align:"right",sortable:!0},{name:"r_estimated_amount",field:i=>P(+i.r_estimated_amount),label:"Estimado",align:"right",sortable:!0},{name:"rsb_requisition_number",field:"rsb_requisition_number",label:"Requisici\xF3n",align:"right",sortable:!0},{name:"rsb_estimated_amount",field:i=>P(+i.rsb_estimated_amount),label:"Estimado",align:"right",sortable:!0},{name:"po_payment_file",field:"po_payment_file",label:"Archivo de pago",align:"center",sortable:!1},{name:"actions",field:"actions",label:"Acciones",align:"center"}],c=m(["a_description","po_payment_number","po_amount","po_payment_date","por_order_number","por_reception_date","r_requisition_number","r_estimated_amount","po_payment_file","actions"]),y=m(!1),D=m(-1);let s=le({purchase_order_id:"",payment_number:"",amount:0,payment_date:new Date().toISOString().substring(0,10),payment_file:"",check_number:"",check_file:"",is_submitted_to_finance:!1});const u={purchase_order_id:"",payment_number:"",amount:0,payment_date:new Date().toISOString().substring(0,10),payment_file:"",check_number:"",check_file:"",is_submitted_to_finance:!1},l=m(""),C=m(!1),$=m(void 0);he(()=>{p.value&&(c.value.splice(1,0,"sb_event"),c.value.splice(7,2,"rsb_requisition_number","rsb_estimated_amount"))}),te(y,i=>{i||me()}),te(p,i=>{f.replace({query:{...v.query,show:i?"subpresupuestos":"presupuestos"}}),i?(c.value.splice(1,0,"sb_event"),c.value.splice(7,2,"rsb_requisition_number","rsb_estimated_amount")):(c.value.splice(1,1),c.value.splice(6,2,"r_requisition_number","r_estimated_amount"))});const ue=we(()=>p.value?"\xD3rdenes de pago/SubPresupuestos":"\xD3rdenes de pago/Presupuestos");function de(i){var ee;const{payment_number:d,amount:r,payment_date:F,payment_file:T,check_number:Y,check_file:B,id:R,is_submitted_to_finance:j,purchase_order_id:L}=pe(i);D.value=(ee=h.value)==null?void 0:ee.findIndex(fe=>fe.po_id===i.po_id),s=Object.assign({},{id:R,purchase_order_id:L,payment_number:d,amount:r,payment_date:F,payment_file:T,check_number:Y,check_file:B,is_submitted_to_finance:j}),y.value=!0}function me(){y.value=!1,Fe(()=>{s=W(u),D.value=-1})}function pe(i){const{po_payment_number:d,po_amount:r,po_payment_date:F,po_payment_file:T,po_check_number:Y,po_check_file:B,po_id:R,po_is_submitted_to_finance:j,po_purchase_order_id:L}=i;return{id:R,purchase_order_id:L,payment_number:d,amount:+r,payment_date:H(F,"YYYY-MM-DD"),payment_file:T,check_number:Y,check_file:B,is_submitted_to_finance:j}}async function ce(){await S.mutateAsync({id:$.value}),Z()}function _e(i){$.value=i,C.value=!0}function Z(){C.value=!1,$.value=void 0}return(i,d)=>(Q(),x(Se,null,{default:t(()=>[e(qe,null,{"card-body":t(()=>[e(Qe,{columns:E,filter:l.value,flat:"",loading:_(k),pagination:{rowsPerPage:20},rows:_(h),"visible-columns":c.value,"wrap-cells":""},{top:t(()=>[Ve("div",Je,z(_(ue)),1),e(ye),e(be,{modelValue:p.value,"onUpdate:modelValue":d[0]||(d[0]=r=>p.value=r),class:"tw-mr-4",label:"Mostrar las \xF3rdenes de pago de los SubPresupuestos"},null,8,["modelValue"]),e(N,{modelValue:l.value,"onUpdate:modelValue":d[1]||(d[1]=r=>l.value=r),class:"q-mr-xs",clearable:"",debounce:"300",dense:"",outlined:"",placeholder:"Buscar"},{append:t(()=>[e(K,{name:"search"})]),_:1},8,["modelValue"]),e(w,{color:"primary",label:"Nueva orden de pago",onClick:d[2]||(d[2]=r=>y.value=!0)})]),"body-cell-consecutiveId":t(r=>[e(I,{props:r},{default:t(()=>[G(z((r.rowIndex+1).toString()),1)]),_:2},1032,["props"])]),"body-cell-po_payment_number":t(r=>[e(I,{props:r},{default:t(()=>[r.value?(Q(),x(w,{key:0,color:"primary",flat:"","no-caps":"",onClick:F=>de(r.row)},{default:t(()=>[G(z(r.value),1)]),_:2},1032,["onClick"])):ke("",!0)]),_:2},1032,["props"])]),"body-cell-po_payment_file":t(r=>[e(I,{props:r},{default:t(()=>[e(ie,{"file-url":`${_(n)}/api/files/payment-orders/${r.row.po_id}/${r.row.po_payment_file}`},null,8,["file-url"])]),_:2},1032,["props"])]),"body-cell-actions":t(r=>[e(I,{props:r},{default:t(()=>[e(w,{color:"negative",flat:"",icon:"delete",round:"",onClick:F=>_e(r.row.po_id)},null,8,["onClick"])]),_:2},1032,["props"])]),_:1},8,["filter","loading","rows","visible-columns"])]),footer:t(()=>[e(ae,{modelValue:y.value,"onUpdate:modelValue":d[3]||(d[3]=r=>y.value=r),"card-title":"Orden de pago",class:"form-payment-order"},{default:t(({closeDialog:r})=>[e(Xe,{"payment-order":_(s),onClose:r},null,8,["payment-order","onClose"])]),_:1},8,["modelValue"]),e(ae,{modelValue:C.value,"onUpdate:modelValue":d[4]||(d[4]=r=>C.value=r),"card-title":"\xBFDesea eliminar la orden de pago?"},{"close-button":t(()=>[e(w,{dense:"",flat:"",icon:"close",round:"",onClick:Z})]),default:t(()=>[e(se,null,{default:t(()=>[e(xe,{class:"text-white bg-red","inline-actions":""},{action:t(()=>[e(w,{color:"white",flat:"",label:"Confirmar",loading:_(o),onClick:ce},null,8,["loading"])]),default:t(()=>[G(" \xA1Atenci\xF3n! Esta acci\xF3n no se puede deshacer ")]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}))}});export{Ut as default};
